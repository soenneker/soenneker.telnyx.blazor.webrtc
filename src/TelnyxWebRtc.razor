@using System.Text.Json
@using System.Threading
@using Microsoft.JSInterop
@using Soenneker.Extensions.Task
@using Soenneker.Extensions.ValueTask
@using Soenneker.Blazor.Extensions.EventCallback
@using Soenneker.Extensions.CancellationTokens
@using Soenneker.Telnyx.Blazor.WebRtc.Abstract
@using Soenneker.Telnyx.Blazor.WebRtc.Configuration
@using Soenneker.Telnyx.Blazor.WebRtc.Dtos
@using Soenneker.Telnyx.Blazor.WebRtc.Enums
@using Soenneker.Utils.Json

@inject ITelnyxWebRtcInterop TelnyxWebRtcInterop

@inherits Soenneker.Quark.CoreCancellableElement
@implements ITelnyxWebRtc

<div id="@Id" @attributes="Attributes" >

    @if (RenderHiddenAudio)
    {
        <audio id="@_remoteElementId" autoplay playsinline style="display:none" > </audio>
    }
    else if (RenderVideo)
    {
        <video id="@_localElementId" autoplay playsinline muted > </video>
        <video id="@_remoteElementId" autoplay playsinline muted > </video>
    }

    @ChildContent
</div>

@code {

    [Parameter]
    public bool RenderHiddenAudio { get; set; } = true;

    [Parameter]
    public bool RenderVideo { get; set; }

    [Parameter]
    public EventCallback OnInitialize { get; set; }

    [Parameter]
    public EventCallback OnReady { get; set; }

    [Parameter]
    public EventCallback<string> OnMessage { get; set; }

    [Parameter]
    public EventCallback<string> OnError { get; set; }

    [Parameter]
    public EventCallback<string> OnCallInitiated { get; set; }

    [Parameter]
    public EventCallback<string> OnCallAnswered { get; set; }

    [Parameter]
    public EventCallback<string> OnCallHangup { get; set; }

    [Parameter]
    public EventCallback<string> OnCallHeld { get; set; }

    [Parameter]
    public EventCallback<string> OnCallResumed { get; set; }

    [Parameter]
    public EventCallback OnLocalStream { get; set; }

    [Parameter]
    public EventCallback OnRemoteStream { get; set; }

    [Parameter]
    public EventCallback OnStreamStopped { get; set; }

    [Parameter]
    public EventCallback<string> OnDevicesChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnConferenceUpdate { get; set; }

    [Parameter]
    public EventCallback<string> OnStatsUpdate { get; set; }

    [Parameter]
    public EventCallback<TelnyxNotification> OnNotification { get; set; }

    [Parameter]
    public EventCallback OnSocketOpen { get; set; }

    [Parameter]
    public EventCallback OnSocketClose { get; set; }

    [Parameter]
    public EventCallback<string> OnSocketError { get; set; }

    [Parameter]
    public EventCallback OnReconnecting { get; set; }

    [Parameter]
    public EventCallback OnReconnected { get; set; }

    [Parameter]
    public EventCallback OnDisconnected { get; set; }

    [Parameter]
    public double SpeakerVolume { get; set; } = 1.0;

    [Parameter]
    public EventCallback<double> SpeakerVolumeChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnRawSocketMessage { get; set; }

    private readonly string _guid = Guid.NewGuid().ToString();

    private readonly string _remoteElementId;
    private readonly string _localElementId;

    private DotNetObjectReference<TelnyxWebRtc>? _dotNetReference;

    [Parameter]
    public TelnyxClientOptions? Options { get; set; }

    private bool _initialized;

    private double _lastSpeakerVolume = 1.0;
    private bool _pendingVolumeApply;
    private TelnyxCallState? _prevCallState;

    public TelnyxWebRtc()
    {
        Id = $"telnyx-webrtc-{_guid}";
        _remoteElementId = $"telnyx-remote-{_guid}";
        _localElementId = $"telnyx-local-{_guid}";
    }

    protected override async Task OnInitializedAsync()
    {
        await TelnyxWebRtcInterop.Initialize(Options?.UseCdn ?? true, CancellationToken).NoSync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (RenderVideo && Options.InitOptions.LocalElement is null)
                Options.InitOptions.LocalElement = _localElementId;

            if (Options.InitOptions.RemoteElement is null)
                Options.InitOptions.RemoteElement = _remoteElementId;

            await Initialize(null, CancellationToken).NoSync();
        }

        if (RenderHiddenAudio && (firstRender || _pendingVolumeApply))
        {
            await ApplySpeakerVolume(SpeakerVolume, CancellationToken).NoSync();
            _pendingVolumeApply = false;
        }
    }

    protected override void OnParametersSet()
    {
        if (RenderHiddenAudio && Math.Abs(SpeakerVolume - _lastSpeakerVolume) > 0.001)
        {
            _pendingVolumeApply = true;
            _lastSpeakerVolume = SpeakerVolume;
        }
    }

    private async ValueTask ApplySpeakerVolume(double volume, CancellationToken ct = default)
    {
        if (!RenderHiddenAudio || TelnyxWebRtcInterop is null)
            return;

        await TelnyxWebRtcInterop.SetAudioVolume(_remoteElementId!, volume, ct).NoSync();
    }

    public async ValueTask Initialize(TelnyxClientOptions? options = null, CancellationToken cancellationToken = default)
    {
        _initialized = true;

        if (options != null)
            Options = options;

        if (Options == null)
            throw new InvalidOperationException("TelnyxWebRtcOptions must be set");

        _dotNetReference = DotNetObjectReference.Create(this);

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Create( Id!, _dotNetReference, Options, linked).NoSync();
            await TelnyxWebRtcInterop.CreateObserver( Id!, linked).NoSync();
        }
    }

    public async ValueTask Call(TelnyxCallOptions callOptions, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Call( Id!, callOptions, linked).NoSync();
        }
    }

    public async ValueTask Answer(TelnyxAnswerOptions? options = null, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Answer( Id!, options, linked).NoSync();
        }
    }

    public async ValueTask Hangup(TelnyxHangupOptions? options = null, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Hangup( Id!, options, linked).NoSync();
        }
    }

    public async ValueTask MuteAudio(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.MuteAudio( Id!, linked).NoSync();
        }
    }

    public async ValueTask UnmuteAudio(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.UnmuteAudio( Id!, linked).NoSync();
        }
    }

    public async ValueTask ToggleAudioMute(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ToggleAudioMute( Id!, linked).NoSync();
        }
    }

    public async ValueTask MuteVideo(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.MuteVideo( Id!, linked).NoSync();
        }
    }

    public async ValueTask UnmuteVideo(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.UnmuteVideo( Id!, linked).NoSync();
        }
    }

    public async ValueTask ToggleVideoMute(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ToggleVideoMute( Id!, linked).NoSync();
        }
    }

    public async ValueTask Deaf(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Deaf( Id!, linked).NoSync();
        }
    }

    public async ValueTask Undeaf(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Undeaf( Id!, linked).NoSync();
        }
    }

    public async ValueTask ToggleDeaf(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ToggleDeaf( Id!, linked).NoSync();
        }
    }

    public async ValueTask Hold(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Hold( Id!, linked).NoSync();
        }
    }

    public async ValueTask Unhold(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Unhold( Id!, linked).NoSync();
        }
    }

    public async ValueTask ToggleHold(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ToggleHold( Id!, linked).NoSync();
        }
    }

    public async ValueTask Dtmf(string digit, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Dtmf( Id!, digit, linked).NoSync();
        }
    }

    public async ValueTask Message(string to, string body, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Message( Id!, to, body, linked).NoSync();
        }
    }

    public async ValueTask SetAudioInDevice(string deviceId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SetAudioInDevice( Id!, deviceId, linked).NoSync();
        }
    }

    public async ValueTask SetVideoDevice(string deviceId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SetVideoDevice( Id!, deviceId, linked).NoSync();
        }
    }

    public async ValueTask SetAudioOutDevice(string deviceId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SetAudioOutDevice( Id!, deviceId, linked).NoSync();
        }
    }

    public async ValueTask StartScreenShare(TelnyxScreenShareOptions? options = null, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.StartScreenShare( Id!, options, linked).NoSync();
        }
    }

    public async ValueTask StopScreenShare(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.StopScreenShare( Id!, linked).NoSync();
        }
    }

    public async ValueTask SetAudioBandwidth(int bps, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SetAudioBandwidth( Id!, bps, linked).NoSync();
        }
    }

    public async ValueTask SetVideoBandwidth(int bps, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SetVideoBandwidth( Id!, bps, linked).NoSync();
        }
    }

    public async ValueTask<List<MediaDeviceInfo>> GetDevices(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            string json = await TelnyxWebRtcInterop.GetDevices( Id!, linked).NoSync();
            return JsonUtil.Deserialize<List<MediaDeviceInfo>>(json) ?? [];
        }
    }

    public async ValueTask<List<MediaDeviceInfo>> GetVideoDevices(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            string json = await TelnyxWebRtcInterop.GetVideoDevices( Id!, linked).NoSync();
            return JsonUtil.Deserialize<List<MediaDeviceInfo>>(json) ?? [];
        }
    }

    public async ValueTask<List<MediaDeviceInfo>> GetAudioInDevices(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            string json = await TelnyxWebRtcInterop.GetAudioInDevices( Id!, linked).NoSync();
            return JsonUtil.Deserialize<List<MediaDeviceInfo>>(json) ?? [];
        }
    }

    public async ValueTask<List<MediaDeviceInfo>> GetAudioOutDevices(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            string json = await TelnyxWebRtcInterop.GetAudioOutDevices( Id!, linked).NoSync();
            return JsonUtil.Deserialize<List<MediaDeviceInfo>>(json) ?? [];
        }
    }

    public async ValueTask<bool> CheckPermissions(bool audio = true, bool video = true, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            return await TelnyxWebRtcInterop.CheckPermissions( Id!, audio, video, linked).NoSync();
        }
    }

    public async ValueTask<bool> SetAudioSettings(TelnyxAudioSettings settings, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            return await TelnyxWebRtcInterop.SetAudioSettings( Id!, settings, linked).NoSync();
        }
    }

    public async ValueTask<bool> SetVideoSettings(TelnyxVideoSettings settings, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            return await TelnyxWebRtcInterop.SetVideoSettings( Id!, settings, linked).NoSync();
        }
    }

    public async ValueTask EnableMicrophone(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.EnableMicrophone( Id!, linked).NoSync();
        }
    }

    public async ValueTask DisableMicrophone(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.DisableMicrophone( Id!, linked).NoSync();
        }
    }

    public async ValueTask EnableWebcam(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.EnableWebcam( Id!, linked).NoSync();
        }
    }

    public async ValueTask DisableWebcam(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.DisableWebcam( Id!, linked).NoSync();
        }
    }

    public async ValueTask ToggleAudio(bool enabled, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ToggleAudio( Id!, enabled, linked).NoSync();
        }
    }

    public async ValueTask ToggleVideo(bool enabled, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ToggleVideo( Id!, enabled, linked).NoSync();
        }
    }

    public async ValueTask Disconnect(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Disconnect( Id!, linked).NoSync();
        }
    }

    public async ValueTask Reconnect(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Reconnect( Id!, linked).NoSync();
        }
    }

    public async ValueTask Connect(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Connect( Id!, linked).NoSync();
        }
    }

    // Conference control methods
    public async ValueTask ListVideoLayouts(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.ListVideoLayouts( Id!, linked).NoSync();
        }
    }

    public async ValueTask SetVideoLayout(string layout, string? canvas = null, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SetVideoLayout( Id!, layout, canvas, linked).NoSync();
        }
    }

    public async ValueTask PlayMedia(string source, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.PlayMedia( Id!, source, linked).NoSync();
        }
    }

    public async ValueTask StopMedia(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.StopMedia( Id!, linked).NoSync();
        }
    }

    public async ValueTask StartRecord(string filename, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.StartRecord( Id!, filename, linked).NoSync();
        }
    }

    public async ValueTask StopRecord(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.StopRecord( Id!, linked).NoSync();
        }
    }

    public async ValueTask SendChatMessage(string message, string? type = null, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.SendChatMessage( Id!, message, type, linked).NoSync();
        }
    }

    public async ValueTask Snapshot(string filename, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Snapshot( Id!, filename, linked).NoSync();
        }
    }

    public async ValueTask MuteMic(string participantId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.MuteMic( Id!, participantId, linked).NoSync();
        }
    }

    public async ValueTask MuteVideoParticipant(string participantId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.MuteVideoParticipant( Id!, participantId, linked).NoSync();
        }
    }

    public async ValueTask Kick(string participantId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.Kick( Id!, participantId, linked).NoSync();
        }
    }

    public async ValueTask VolumeUp(string participantId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.VolumeUp( Id!, participantId, linked).NoSync();
        }
    }

    public async ValueTask VolumeDown(string participantId, CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            await TelnyxWebRtcInterop.VolumeDown( Id!, participantId, linked).NoSync();
        }
    }

    public async ValueTask<string?> GetCallStats(CancellationToken cancellationToken = default)
    {
        if (!_initialized)
            throw new InvalidOperationException("WebRTC has not been initialized yet.");

        CancellationToken linked = CancellationToken.Link(cancellationToken, out CancellationTokenSource? cts);

        using (cts)
        {
            return await TelnyxWebRtcInterop.GetCallStats( Id!, linked).NoSync();
        }
    }

    [JSInvokable("HandleTelnyxEvent")]
    public async Task HandleTelnyxEvent(string eventName, string jsonArgs)
    {
        switch (eventName)
        {
            case "initialized":
                await OnInitialize.InvokeIfHasDelegate().NoSync();
                return;

            case "ready":
                await OnReady.InvokeIfHasDelegate().NoSync();
                return;

            case "error":
                await OnError.InvokeIfHasDelegate(jsonArgs).NoSync();
                return;

            case "notification":
                try
                {
                    var notification = JsonUtil.Deserialize<TelnyxNotification>(jsonArgs);

                    if (notification is not null)
                        await OnNotification.InvokeIfHasDelegate(notification).NoSync();

                    switch (notification.Type)
                    {
                        case "callUpdate":
                        {
                            TelnyxCallState? currentState = notification.Call.State;

                            /* ────── RESUME DETECTION ────── */
                            if (_prevCallState == TelnyxCallState.Held && currentState == TelnyxCallState.Active)
                            {
                                await OnCallResumed.InvokeIfHasDelegate(jsonArgs).NoSync();
                            }

                            _prevCallState = currentState;
                            /* ─────────────────────────────────── */

                            switch (currentState.Name)
                            {
                                case nameof(TelnyxCallState.New):
                                case nameof(TelnyxCallState.Trying):
                                case nameof(TelnyxCallState.Requesting):
                                case nameof(TelnyxCallState.Recovering):
                                    await OnCallInitiated.InvokeIfHasDelegate(jsonArgs).NoSync();
                                    break;

                                case nameof(TelnyxCallState.Ringing):
                                case nameof(TelnyxCallState.Answering):
                                case nameof(TelnyxCallState.Early):
                                case nameof(TelnyxCallState.Active):
                                    await OnCallAnswered.InvokeIfHasDelegate(jsonArgs).NoSync();
                                    break;

                                case nameof(TelnyxCallState.Held):
                                    await OnCallHeld.InvokeIfHasDelegate(jsonArgs).NoSync();
                                    break;

                                case nameof(TelnyxCallState.Hangup):
                                case nameof(TelnyxCallState.Destroy):
                                case nameof(TelnyxCallState.Purge):
                                    await OnCallHangup.InvokeIfHasDelegate(jsonArgs).NoSync();
                                    break;
                            }

                            break;
                        }

                        case "conferenceUpdate":
                            await OnConferenceUpdate.InvokeIfHasDelegate(jsonArgs).NoSync();
                            break;

                        default:
                            await OnMessage.InvokeIfHasDelegate(jsonArgs).NoSync();
                            break;
                    }
                }
                catch (JsonException ex)
                {
                    await OnError.InvokeIfHasDelegate($"Failed to parse notification: {ex.Message}").NoSync();
                }

                return;

            case "socket.open":
                await OnSocketOpen.InvokeIfHasDelegate().NoSync();
                return;

            case "socket.close":
                await OnSocketClose.InvokeIfHasDelegate().NoSync();
                return;

            case "socket.error":
                await OnSocketError.InvokeIfHasDelegate(jsonArgs).NoSync();
                return;

            case "reconnecting":
                await OnReconnecting.InvokeIfHasDelegate().NoSync();
                return;

            case "reconnected":
                await OnReconnected.InvokeIfHasDelegate().NoSync();
                return;

            case "disconnected":
                await OnDisconnected.InvokeIfHasDelegate().NoSync();
                return;

            case "localStream":
                await OnLocalStream.InvokeIfHasDelegate().NoSync();
                return;

            case "remoteStream":
                await OnRemoteStream.InvokeIfHasDelegate().NoSync();
                return;

            case "streamStopped":
                await OnStreamStopped.InvokeIfHasDelegate().NoSync();
                return;

            case "stats.report":
            case "stats.frame":
                await OnStatsUpdate.InvokeIfHasDelegate(jsonArgs).NoSync();
                return;

            case "deviceChange":
                await OnDevicesChanged.InvokeIfHasDelegate(jsonArgs).NoSync();
                return;

            case "rawSocketMessage":
                await OnRawSocketMessage.InvokeIfHasDelegate(jsonArgs).NoSync();
                return;
        }
    }


    public override async ValueTask DisposeAsync()
    {
        await base.DisposeAsync().NoSync();

        _dotNetReference?.Dispose();
    }

}